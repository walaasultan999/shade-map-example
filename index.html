<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src='https://www.unpkg.com/suncalc@1.9.0/suncalc.js'></script>
    <script src="https://unpkg.com/osmtogeojson/osmtogeojson.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-shadow-simulator/dist/leaflet-shadow-simulator.umd.min.js"></script>
    <script src="map.js" type="module"></script>

    <style>
        body {
            padding: 0px;
            margin: 0px;
            display: flex;
            flex-direction: column;
        }

        #mapid {
            height: 100vh;
            flex: 1;
        }

        .leaflet-control-time.leaflet-control {
            padding: 20px;
            background-color: white;
        }

        #exposure-gradient-container {
            display: none;
            background-color: white;
            padding: 0 10px 5px;
            margin-top: 0;
            float: none;
        }

        #exposure-gradient {
            height: 20px;
            background-image: linear-gradient(to right, rgb(0 0 255/ 0.5), rgb(0 255 0 / 0.5), rgb(255 0 0 / 0.5));
            display: flex;
        }

        #exposure-gradient>div {
            flex: 1;
            border: 1px solid white;
            text-align: center;
            font-weight: bold;
        }

        /* Search box styling */
        #search-box {
            width: 200px;
            margin: 10px auto;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
        }
    </style>
    <title>Shade Map Leaflet Example</title>
</head>

<body>
    <!-- Search Box for location input -->
    <input id="search-box" type="text" placeholder="Enter location or lat, long" />

    <!-- Map container -->
    <div id="mapid"></div>

    <div class="leaflet-control-container">
        <div class="leaflet-top leaflet-left">
            <div class="leaflet-control-time leaflet-control">
                <h2 style="text-align: Start; margin: 0 0 10px;">Layout Zoo / Site Analysis Tools</h2>
                <button id="decrement">-1 hour</button>
                <button id="increment">+1 hour</button>
                <button id="play">Play</button>
                <button id="stop">Stop</button>
                <label><input id="exposure" type="checkbox" autocomplete="off" /> Full-day sun exposure</label>
                <span id="loader" style="padding: 3px;"></span>
            </div>
            <div class="leaflet-control-time leaflet-control" id="exposure-gradient-container">
                <div>Hours of sunlight</div>
                <div id="exposure-gradient"></div>
            </div>
        </div>
    </div>

    <script>
        /* Leaflet setup */
        const map = L.map("mapid", { zoomControl: false }).setView([26.15389069462562, 50.54363557201848], 18);
        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        /* End Leaflet setup */

        /* ShadeMap setup */
        const loaderEl = document.getElementById('loader');
        let now = new Date(1633358583454);
        const shadeMap = L.shadeMap({
            apiKey: "your-api-key",
            date: now,
            color: '#01112f',
            opacity: 0.7,
            terrainSource: {
                maxZoom: 15,
                tileSize: 256,
                getSourceUrl: ({ x, y, z }) => `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${z}/${x}/${y}.png`,
                getElevation: ({ r, g, b, a }) => (r * 256 + g + b / 256) - 32768,
                _overzoom: 18,
            },
            getFeatures: async () => {
                // Implementation for fetching features
            },
            debug: (msg) => { console.log(new Date().toISOString(), msg) }
        }).addTo(map);

        shadeMap.on('tileloaded', (loadedTiles, totalTiles) => {
            loaderEl.innerText = `Loading: ${(loadedTiles / totalTiles * 100).toFixed(0)}%`;
        });
        /* End ShadeMap setup */

        /* Controls setup */
        let intervalTimer;
        const increment = document.getElementById('increment');
        const decrement = document.getElementById('decrement');
        const play = document.getElementById('play');
        const stop = document.getElementById('stop');
        const exposure = document.getElementById('exposure');
        const exposureGradientContainer = document.getElementById('exposure-gradient-container');
        const exposureGradient = document.getElementById('exposure-gradient');

        increment.addEventListener('click', () => {
            now = new Date(now.getTime() + 3600000);
            shadeMap.setDate(now);
        }, false);

        decrement.addEventListener('click', () => {
            now = new Date(now.getTime() - 3600000);
            shadeMap.setDate(now);
        }, false);

        play.addEventListener('click', () => {
            intervalTimer = setInterval(() => {
                now = new Date(now.getTime() + 60000);
                shadeMap.setDate(now);
            }, 100);
        });

        stop.addEventListener('click', () => {
            clearInterval(intervalTimer);
        });

        exposure.addEventListener('click', (e) => {
            clearInterval(intervalTimer);
            const target = e.target;
            if (!target.checked) {
                shadeMap && shadeMap.setSunExposure(false);
                increment.disabled = false;
                decrement.disabled = false;
                play.disabled = false;
                stop.disabled = false;
                exposureGradientContainer.style.display = 'none';
            } else {
                const { lat, lng } = map.getCenter();
                const { sunrise, sunset } = SunCalc.getTimes(now, lat, lng);
                shadeMap && shadeMap.setSunExposure(true, {
                    startDate: sunrise,
                    endDate: sunset
                });
                increment.disabled = true
                decrement.disabled = true;
                play.disabled = true;
                stop.disabled = true;

                const hours = (sunset - sunrise) / 1000 / 3600;
                const partial = hours - Math.floor(hours);
                const html = [];
                for (let i = 0; i < hours; i++) {
                    html.push(`<div>${i + 1}</div>`)
                }
                html.push(`<div style="flex: ${partial}"></div>`);
                exposureGradientContainer.style.display = 'block';
                exposureGradient.innerHTML = html.join('');
            }
        });

        /* Map Location Search */
        const searchBox = document.getElementById('search-box');
        searchBox.addEventListener('input', async () => {
            const query = searchBox.value.trim();
            if (query) {
                let lat, lng;
                if (query.includes(',')) {
                    // If it's a lat,long entry, parse it
                    [lat, lng] = query.split(',').map(Number);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        map.setView([lat, lng], 18);
                    }
                } else {
                    // Otherwise, treat it as a location name and geocode it
                    const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
                    const response = await fetch(geocodeUrl);
                    const data = await response.json();
                    if (data && data[0]) {
                        lat = parseFloat(data[0].lat);
                        lng = parseFloat(data[0].lon);
                        map.setView([lat, lng], 18);
                    }
                }
            }
        });
        /* End Map Location Search */
    </script>
</body>

</html>
